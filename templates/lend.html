{% extends "base.html" %}

{% block title %}Lend Tool{% endblock %}

{% block content %}
    <h1 class="mt-5">Lend Tool</h1>

    <!-- QR Code Scanner Section -->
    <button type="button" class="btn btn-secondary mt-3" data-toggle="modal" data-target="#qrModal">
        Scan QR Code to Lend Tool
    </button>

    <!-- QR Code Scanner Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1" role="dialog" aria-labelledby="qrModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrModalLabel">Scan QR Code</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="qr-reader" style="width:100%"></div>
                    <form id="qr-form" method="POST" action="{{ url_for('lend_qr') }}">
                        <input type="hidden" id="qr_data" name="qr_data">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" class="mt-3">
        <div class="form-group">
            <label for="tool_id">Tool:</label>
            <select id="tool_id" name="tool_id" class="form-control" required>
                {% for tool in tools %}
                <option value="{{ tool.id }}">{{ tool.name }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Lend Tool</button>
    </form>

    <h2 class="mt-5">Currently Borrowed Tools</h2>
    <ul class="list-group mt-3">
        {% for tool in borrowed_tools %}
        <li class="list-group-item">{{ tool.name }}</li>
        {% endfor %}
    </ul>

    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script>
        function onScanSuccess(decodedText, decodedResult) {
            document.getElementById('qr_data').value = decodedText;
            document.getElementById('qr-form').submit();
        }

        // Ensure the scanner is initialized only when the modal is shown
        $('#qrModal').on('shown.bs.modal', function () {
            var html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", { fps: 10, qrbox: 250 });
            html5QrcodeScanner.render(onScanSuccess);
        });

        // Ensure the scanner is cleared when the modal is hidden
        $('#qrModal').on('hidden.bs.modal', function () {
            var qrReader = document.getElementById('qr-reader');
            qrReader.innerHTML = "";
        });
    </script>
{% endblock %}
