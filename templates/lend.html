{% extends "base.html" %}

{% block title %}Lend Tool{% endblock %}

{% block content %}
    <h1 class="mt-5">Lend Tool</h1>
    <form method="POST" class="mt-3">
        <div class="form-group">
            <label for="tool_id">Tool:</label>
            <select id="tool_id" name="tool_id" class="form-control" required>
                {% for tool in tools %}
                <option value="{{ tool.id }}">{{ tool.name }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Lend Tool</button>
    </form>

    <h2 class="mt-5">Currently Borrowed Tools</h2>
    <ul class="list-group mt-3">
        {% for tool in borrowed_tools %}
        <li class="list-group-item">{{ tool.name }}</li>
        {% endfor %}
    </ul>

    <h2 class="mt-5">Scan QR Code to Lend Tool</h2>
    <button id="scanBtn" class="btn btn-secondary mt-3">Scan QR Code</button>
    <div id="qrScanner" style="display:none;">
        <video id="video" class="mt-3" width="300" height="300" style="border: 1px solid black;" autoplay></video>
        <div id="result" class="mt-3">No QR code detected yet.</div>
        <div id="debug" class="mt-3"></div>
    </div>
    <form method="POST" action="{{ url_for('lend_qr') }}" id="qrForm" style="display:none;">
        <input type="hidden" name="qr_data" id="qr_data">
        <button type="submit" class="btn btn-primary mt-3">Lend Tool via QR</button>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/qr-scanner/qr-scanner.min.js"></script>
    <script>
        const scanBtn = document.getElementById('scanBtn');
        const qrScannerDiv = document.getElementById('qrScanner');
        const videoElem = document.getElementById('video');
        const resultElem = document.getElementById('result');
        const debugElem = document.getElementById('debug');
        const qrForm = document.getElementById('qrForm');
        const qrDataInput = document.getElementById('qr_data');
        let qrScanner;

        scanBtn.addEventListener('click', () => {
            qrScannerDiv.style.display = 'block';
            startScanner();
        });

        function startScanner() {
            qrScanner = new QrScanner(videoElem, result => {
                console.log('decoded qr code:', result);
                resultElem.textContent = `QR Code Result: ${result}`;
                qrDataInput.value = result;
                qrForm.style.display = 'block';
                qrScanner.stop();
            }, {
                onDecodeError: error => {
                    console.error('QR scanner decode error:', error);
                    resultElem.textContent = `Decode Error: ${error}`;
                },
                highlightScanRegion: true,
            });

            qrScanner.start().then(() => {
                console.log('QR scanner started');
            }).catch(error => {
                console.error('QR scanner start error:', error);
                resultElem.textContent = `Error: ${error.message}`;
            });

            // Optional: Log errors
            qrScanner.$canvas.addEventListener('error', (error) => {
                console.error('QR scanner canvas error:', error);
            });

            qrScanner.onDecode = result => {
                debugElem.textContent = `Continuous decode: ${result}`;
            };
        }

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } })
                .then(stream => {
                    videoElem.srcObject = stream;
                    videoElem.play();
                })
                .catch(error => {
                    console.error('Error accessing camera:', error);
                    resultElem.textContent = `Error accessing camera: ${error.message}`;
                });
        } else {
            console.error('getUserMedia not supported');
            resultElem.textContent = 'Error: getUserMedia not supported by this browser.';
        }
    </script>
{% endblock %}
